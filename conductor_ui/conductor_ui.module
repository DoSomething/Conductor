<?php

/**
 * @file conductor_ui.module
 *   Provides the admin interface for Conductor.
 */

/**
 * General TODO's for this file:
 *
 * TODO: Move page callbacks into a pages.inc
 */

/**
 * Implements hook_menu().
 */
function conductor_ui_menu() {
  $items = array();
  $items['admin/structure/conductor'] = array(
    'title' => 'Conductor Workflows',
    'description' => 'Manage custom workflows',
    'page callback' => 'conductor_ui_list',
    'access arguments' => array('administer conductor workflows'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/structure/conductor/list'] = array(
    'title' => 'List Conductor Workflows',
    'page callback' => 'conductor_ui_list',
    'access arguments' => array('administer conductor workflows'),
    'type' => MENU_DEFAULT_LOCAL_TASK,

  );
  $items['admin/structure/conductor/add'] = array(
    'title' => 'Add A New Workflow',
    'page callback' => 'conductor_ui_add_workflow_page',
    'access arguments' => array('administer conductor workflows'),
    'type' => MENU_LOCAL_TASK,
  );
  $items['conductor_ui/%ctools_js/activity'] = array(
      'title' => 'Activity',
      'page callback' => 'conductor_ui_activity_form',
      'page arguments' => array(1),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implements hook_theme();
 */
function conductor_ui_theme() {
  return array(
    'conductor_activity' => array(
      'variables' => array(
        'name' => '',
        'title' => '',
        'class' => '',
        'drop_links' => '',
      ),
      'path' => drupal_get_path('module', 'conductor_ui') . '/theme',
      'template' => 'conductor-activity'
    ),
  );
}


/**
 * Implements hook_library().
 */
function conductor_ui_library() {
  // jsPlumb.
  $path = drupal_get_path('module', 'conductor_ui') . '/js/';
  $libraries['jsplumb'] = array(
    'title' => 'jsPlumb',
    'website' => 'http://code.google.com/p/jsplumb/',
    'version' => '1.2.2',
    'js' => array(
      $path . 'jsPlumb-1.2.2-RC1.js' => array(),
      $path . 'jsPlumb-defaults-1.2.2-RC1.js' => array(),
      $path . 'jquery.jsPlumb-1.2.2-RC1.js' => array(),
    ),
    'dependencies' => array(
      array('system', 'jquery'),
      array('system', 'ui'),
      array('system', 'ui.draggable'),
      array('system', 'ui.droppable'),
    ),
  );

  return $libraries;
}

/**
 * Implements hook_conductor_activity_process
 * TODO: Test this!
 */
function conductor_ui_conductor_activity_process(&$plugin) {
  $plugin += array(
    'conductor_ui_template' => 'conductor_activity',
  );
}

/**
 * Page callback to list all workflows.
 */
function conductor_ui_list() {
  return '';
}

/**
 * Page callback to add a new workflow.
 */
function conductor_ui_add_workflow_page() {

  drupal_set_title(t('Add a new Conductor workflow'));
  conductor_ui_add_js();
  conductor_ui_add_css();
  ctools_include('modal');
  ctools_include('object-cache');
  ctools_modal_add_js();
  conductor_ui_add_ctools_modal_style();

  $output = array();
  $output['workflow_element_panel'] = array(
    '#prefix' => '<div id="conductor-ui-toolbar">',
    '#suffix' => '</div>',
  );
  $output['workflow_element_panel']['add_activity'] = array(
    '#type' => 'markup',
    '#markup' => ctools_modal_text_button(t('+ Add Activity'), 'conductor_ui/nojs/activity', t('Add an actiivty to this workflow.'), 'ctools-modal-conductor-ui-style-style'),
  );
  $output['workflow_element_panel']['buttons'] = array(
    '#prefix' => '<div id="toolbar-buttons">',
    '#suffix' => '</div>',
  );
  $output['workflow_element_panel']['buttons']['save'] = array(
    '#value' => t('Save'),
    '#type' => 'button',
  );
  $output['workflow_element_panel']['buttons']['cancel'] = array(
    '#value' => t('Cancel'),
    '#type' => 'button',
  );
  $output['workflow_editor'] = array(
    '#prefix' => '<div id="conductor-workflow-editor">',
    '#suffix' => '</div>',
  );
  //if (!$workflow = ctools_object_cache_get('conductor_workflow', 'test')) {
    $workflow = conductor_ui_dev_workflow();
    ctools_object_cache_set('conductor_workflow', 'test', $workflow);
  //}
  $activities = $workflow->getActivities(); 
  $settings = array();
  $css = '';
  foreach ($activities as $name => $activity) {
    $class_name = 'conductor-ui-activity-' . conductor_ui_css_safe_class($activity->name);
    $settings['activities'][$name] = $activity;
    $activity->css_class = $class_name;
    $drop_links = theme('links__ctools_dropbutton', array('title' => t('Edit'), 'links' => $activity->getUILinks()));

    $output['workflow_editor'][$name] = array(
      '#name' => $activity->name,
      '#title' => $activity->title,
      '#class' => $class_name,
      '#drop_links' => $drop_links,
      '#theme' => 'conductor_activity',
      '#contextual_links' => array(
        'contextual_example' => array( 'contextual', array('foobars')),
      ),
    );
  }
  drupal_add_css($css, array('type' => 'inline'));
  drupal_add_js(array('conductor_ui' => $settings), array('type' => 'setting'));
  return $output;
}

/**
 * Retrieve configuration for a 
 * The default 
 */
function conductor_ui_add_ctools_modal_style() {
  // Create our own javascript that will be used to theme a modal.
  $sample_style = array(
    'conductor-ui-style' => array(
      'modalSize' => array(
        'type' => 'fixed',
        'width' => 500,
        'height' => 300,
        'addWidth' => 20,
        'addHeight' => 15,
      ),
      'modalOptions' => array(
        'opacity' => .5,
        'background-color' => '#000',
      ),
      'animation' => 'fadeIn',
      'modalTheme' => 'CToolsSampleModal',
      'throbber' => theme('image', array('path' => ctools_image_path('ajax-loader.gif', 'ctools_ajax_sample'), 'alt' => t('Loading...'), 'title' => t('Loading'))),
    ),
  );
  drupal_add_js($sample_style, 'setting');
}

function conductor_ui_activity_form($js = NULL, $step = NULL) {
  // TODO: Clean this all up.  Alot.
  if ($js) {
    ctools_include('modal');
    ctools_include('ajax');
  }
  $form = array();
  // TODO: This is really a workflow creation form, not an activity form.
  $form['human_name'] = array(
    '#type' => 'textfield',
    '#title' => t('workflow name'),
    '#required' => TRUE,
    '#size' => 32,
    '#default_value' => !empty($form_state['view']) ? $form_state['view']->human_name : '',
    '#maxlength' => 255,
  );
  $form['name'] = array(
    '#type' => 'machine_name',
    '#maxlength' => 32,
    '#machine_name' => array(
      'exists' => 'conductor_get_workflow',
      'source' => array('human_name'),
    ),
    '#description' => t('A unique machine-readable name for this View. It must only contain lowercase letters, numbers, and underscores.'),
  );

  $output = drupal_render($form);

  // If $output is FALSE, there was no actual form.
  if ($js) {
    // If javascript is active, we have to use a render array.
    $commands = array();
    if ($output === FALSE || !empty($form_state['complete'])) {
      // Dismiss the modal.
      $commands[] = ajax_command_html('#ctools-sample', $animal);
      $commands[] = ctools_modal_command_dismiss();
    }
    else if (!empty($form_state['cancel'])) {
      // If cancelling, return to the activity.
      $commands[] = ctools_modal_command_dismiss();
    }
    else {
      $commands = ctools_modal_form_render($form_state, $output);
    }
    print ajax_render($commands);
    exit;
  }
  else {
    if ($output === FALSE || !empty($form_state['complete'])) {
      return $animal;
    }
    else if (!empty($form_state['cancel'])) {
      drupal_goto('ctools_ajax_sample');
    }
    else {
      return $output;
    }
  }
}

/**
 * Convert any string into a CSS class.
 *
 * @param $name
 *   The string to be converted into a W3C standards compliant CSS class.
 *
 * @return
 *   The CSS class name.
 */
function conductor_ui_css_safe_class($name) {
  $class_name = preg_replace('/[^a-zA-Z0-9- ]/', '-', strtolower($name));
  $class_name = preg_replace('/\W+/', '-', $class_name);
  $class_name = preg_replace('/\s+/','-', $class_name); 
  return $class_name;
}

/**
 * Add required javascript for the conductor ui.
 */
function conductor_ui_add_js() {

  drupal_add_library('system', 'ui.draggable');

  // Include jsPlumb for drawing our lines
  drupal_add_library('conductor_ui', 'jsplumb');

  // Include the CTools tools that we need.
  ctools_include('ajax');
  ctools_include('modal');
  drupal_add_js('misc/ajax.js');
  ctools_modal_add_js();

  drupal_add_js(drupal_get_path('module', 'conductor_ui') . '/js/conductor_ui.js');
}

/**
 * Add required css for the conductor ui.
 */
function conductor_ui_add_css() {
  drupal_add_css(drupal_get_path('module', 'conductor_ui') . '/css/conductor_ui.css');
  // The views styling for ctools buttons is nice, lets steal it.
  drupal_add_css(drupal_get_path('module', 'views') . '/css/views-admin.ctools.css');
}

function conductor_ui_dev_workflow() {
  $workflow = new ConductorWorkflow;
  $workflow->id = 'new';
  $workflow->name = 'Example';
  $workflow->description = 'example';
  // Add and configure workflow activities.
  $activity = $workflow->newActivity('activity');
  $activity->x = 180;
  $activity->y = 100;
  $activity->name = 'activity_1';
  $activity->title = 'Activity 1';
  $activity->inputs = array();
  $activity->outputs = array(
    'Activity 2'
  );
  $activity = $workflow->newActivity('activity');
  $activity->x = 280;
  $activity->y = 200;
  $activity->name = 'activity_2';
  $activity->title = 'Activity 2';
  $activity->inputs = array(
    'Activity 2'
  );
  $activity->outputs = array();
  return $workflow;
}
